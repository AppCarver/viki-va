# Component: `brain:conversationLog` (Conversation Log Service)

**1. Component Name:** `brain:conversationLog` (or `ConversationLogService`)

**2. Conceptual Role:** The immutable ledger of all interactions between users and the Virtual Assistant. It acts as the single source of truth for the complete history of every conversation turn, both user utterances and VA responses.

**3. Purpose / Mission:**
To reliably capture, store, and provide access to the raw, timestamped record of every conversation turn. Its mission is to ensure data integrity for auditing, debugging, analytics, and as the foundational data source for long-term memory processing.

---

**4. Responsibilities:**

* **Ingest `ConversationTurn`s:** Receives and permanently stores `ConversationTurn` records generated by `InputProcessor` (for user turns) and `OutputManager` (for VA turns).
* **Immutability:** Ensures that once a `ConversationTurn` is logged, it cannot be altered or deleted (only marked as invalid if necessary, but the original record remains).
* **Timestamping:** Automatically applies accurate timestamps to every ingested turn.
* **Indexing & Querying:** Provides efficient mechanisms to query and retrieve conversation turns based on `conversation_id`, `user_id`, `timestamp_range`, etc.
* **Data Retention:** Manages data retention policies (e.g., how long raw conversation logs are kept).
* **High Write Throughput:** Designed to handle a very high volume of incoming `ConversationTurn` records with minimal latency impact on real-time flows.
* **Auditing & Compliance:** Serves as the primary record for internal audits, compliance checks, and dispute resolution.

---

**5. Data Models Managed/Accessed:**

* **Manages:** **`ConversationTurn`** (the primary data model it stores).
* **Accesses:** May implicitly link to `Conversation` and `User` records through their IDs within `ConversationTurn` for indexing purposes.

---

**6. API / Interfaces:**

* **`logTurn(turn: ConversationTurn)`:**
    * **Description:** Stores a new `ConversationTurn` record.
    * **Input:** `turn` (a fully formed `ConversationTurn` object).
    * **Output:** `turn_id` (UUID) of the newly logged turn, or confirmation of success.
* **`getConversationTurns(conversationId: UUID, fromTimestamp?: datetime, toTimestamp?: datetime, limit?: int, offset?: int)`:**
    * **Description:** Retrieves a sequence of `ConversationTurn` records for a specific conversation.
    * **Input:** `conversationId` (UUID), optional filters.
    * **Output:** List of `ConversationTurn` objects, ordered by `turn_number` or `timestamp`.
* **`getRecentUserTurns(userId: UUID, limit?: int)`:**
    * **Description:** Retrieves the most recent `ConversationTurn`s across all conversations for a given user.
    * **Input:** `userId` (UUID), `limit`.
    * **Output:** List of `ConversationTurn` objects.

---

**7. Internal Architecture / Implementation Notes:**

* Often implemented using a highly scalable, write-optimized data store (e.g., Apache Kafka/Cassandra for event sourcing, or a robust relational database with proper indexing, or a specialized log-aggregation system like Elasticsearch).
* May use a message queue internally to decouple logging requests from the main processing flow, ensuring high throughput and resilience.
* Batching of writes is common to optimize performance.
* Considerations for data privacy, encryption at rest, and anonymization for long-term archival.

---

**8. Relationships with Other Components:**

* **`InputProcessor`:** Calls `logTurn` to record user messages.
* **`OutputManager`:** Calls `logTurn` to record VA responses.
* **`brain:long_term_mem`:** Queries `getConversationTurns` (or consumes a stream of turns) to retrieve raw conversation data for summarization and fact extraction.
* **`Analytics Service` (conceptual):** Consumes data from `brain:conversationLog` for usage statistics and insights.
* **`Debugging/Monitoring Tools`:** Directly queries the log for troubleshooting.

---

**9. Lifecycle Considerations:**

* **Continuous Ingestion:** Constantly receiving new `ConversationTurn` records throughout the VA's operation.
* **Archival/Pruning:** Depending on data retention policies, older data might be automatically moved to cheaper storage or permanently deleted.

---

**10. Non-Functional Requirements (Key Focus):**

* **High Write Throughput:** Must handle potentially thousands of `ConversationTurn`s per second.
* **Data Integrity:** Guarantees that logged data is accurate and not lost.
* **Immutability:** Ensures records are tamper-proof.
* **Scalability:** Must scale to accommodate growing volumes of conversational data.
* **Query Performance:** While not real-time critical, efficient querying for analytics and long-term memory is important.