# Data Model: `ConversationTurn`

**1. Data Model Name:** `ConversationTurn`

**2. Conceptual Role / Nickname:** Dialogue Exchange Record / Utterance Log / Transaction Log

**3. Purpose / Mission:**
The `ConversationTurn` data model captures the details of each individual exchange within a `Conversation` session. It meticulously logs both user inputs and the virtual assistant's corresponding responses, providing a granular, chronological record of the dialogue. Its mission is to enable detailed analysis, debugging, and playback of interactions, serving as a comprehensive log of the conversation flow.

---

**4. Schema Definition:**

This model defines the core attributes and structure of a single turn in a conversation.

* **`turn_id`** (`UUID`, Primary Key)
    * **Description:** A unique identifier for this specific conversation turn.
    * **Example:** `f0e9d8c7-b6a5-4321-9876-fedcba098765`
* **`conversation_id`** (`UUID`, Foreign Key to `Conversation` model, Indexed)
    * **Description:** The unique identifier of the `Conversation` session to which this turn belongs.
    * **Example:** `a1b2c3d4-e5f6-7890-1234-567890abcdef`
* **`turn_number`** (`Integer`, Indexed)
    * **Description:** An sequential number indicating the order of this turn within its `Conversation`. Starts from 1.
    * **Example:** `5` (for the 5th turn in a conversation)
* **`speaker`** (`Enum: 'User', 'VA'`)
    * **Description:** Identifies who initiated this turn (the `User` or the `VA`).
    * **Example:** `'User'` or `'VA'`
* **`timestamp`** (`DateTime`, Indexed)
    * **Description:** The exact timestamp when this turn occurred (e.g., when the user's input was received, or when the VA's response was finalized).
    * **Example:** `2025-06-06T10:05:15Z`
* **`raw_input`** (`String`, Optional)
    * **Description:** The original, raw text or a reference to the audio input received from the `User` via the `InputProcessor`. Useful for debugging transcription errors. (Applicable only when `speaker` is 'User').
    * **Example:** `"whats the whether like in london"`
* **`processed_text`** (`String`, Optional)
    * **Description:** The clean, normalized text input from the `User` after pre-processing by the `InputProcessor`. (Applicable only when `speaker` is 'User').
    * **Example:** `"what's the weather like in London"`
* **`nlu_results`** (`JSONB`, Optional)
    * **Description:** The structured output from `brain:language_center`'s NLU component for user turns. Includes identified intent, entities, sentiment, confidence scores, etc. (Applicable only when `speaker` is 'User').
    * **Example:** `{"intent": {"name": "get_weather", "confidence": 0.95}, "entities": [{"type": "location", "value": "London"}], "sentiment": "neutral"}`
* **`va_response_text`** (`String`, Optional)
    * **Description:** The final natural language text generated by `brain:language_center`'s NLG component that was sent to the user. (Applicable only when `speaker` is 'VA').
    * **Example:** `"The weather in London is 20 degrees Celsius and sunny."`
* **`action_taken`** (`JSONB`, Optional)
    * **Description:** Details about any actions or tools executed by the `ActionExecutor` as a result of this turn, including the action name, parameters, and the result/error. (Applicable only when `speaker` is 'VA', or if a user query directly triggered an action without a VA response).
    * **Example:** `{"action_name": "get_weather", "parameters": {"location": "London"}, "success": true, "result_data": {"temperature": 20}}`
* **`va_state_snapshot`** (`JSONB`, Optional)
    * **Description:** A snapshot of the `ConversationContext` (or relevant parts of it) at the conclusion of this turn, as managed by the `brain:pre-frontal_cortex`. Useful for debugging and understanding state transitions.
    * **Example:** `{"active_goal": {"name": "get_weather", "status": "completed"}, "slots_filled": {"location": "London"}}`
* **`metadata`** (`JSONB` or `Text`, Optional)
    * **Description:** A flexible field for storing any additional, unstructured metadata specific to this individual turn.
    * **Example:** `{"response_time_ms": 350, "tts_engine_used": "Google"}`
* **`user_id`** (`UUID`, Foreign Key to `User` model, Indexed)
    * **Description:** The unique identifier of the `User` involved in this specific turn. This provides direct traceability back to the user without needing to join the `Conversation` table, improving query performance for user-centric analyses.
    * **Example:** `user-alpha-123`
* **`device_id`** (`String` or `UUID`, Foreign Key to `Device` model, Indexed, Nullable)
    * **Description:** The identifier of the specific `Device` from which this turn's input originated, or to which the VA's response for this turn was delivered. This allows for direct device-specific analysis of turns. Can be `null` if the conversation is initiated by the VA or if the device context is not relevant for a particular turn.
    * **Example:** `whatsapp-channel-12345`, `alexa-device-abc`

---

**5. Relationships:**

* **Many-to-One (`ConversationTurn` to `Conversation`):**
    * Multiple `ConversationTurn` records are contained within a single `Conversation` session. The `conversation_id` serves as the link.

---

**6. Lifecycle Considerations:**

* **Creation:**
    * A `ConversationTurn` record with `speaker: 'User'` is created by the `InputProcessor` after receiving and pre-processing user input.
    * A `ConversationTurn` record with `speaker: 'VA'` is created by the `brain:pre-frontal_cortex` (or a logging service it orchestrates) after deciding on and generating a response, including the `va_response_text`, `action_taken`, and `va_state_snapshot`.
* **Updates:** `ConversationTurn` records are typically immutable after creation, serving as an audit log. Minor updates might occur for post-processing or analytics tagging.
* **Retention:** The retention policy for `ConversationTurn`s is usually tied to the retention policy of its parent `Conversation`. When a `Conversation` is archived or deleted, its associated `ConversationTurn`s are typically archived or deleted as well.

---

**7. Accessed By / Used By:**

* **`InputProcessor`:** Creates `User` turns.
* **`brain:language_center`:** Populates `nlu_results` for `User` turns and `va_response_text` for `VA` turns.
* **`brain:pre-frontal_cortex`:** Orchestrates the creation and population of `VA` turns, contributing `action_taken` and `va_state_snapshot`.
* **`ActionExecutor`:** Its execution results directly feed into the `action_taken` field for `VA` turns.
* **Analytics and Reporting Tools:** Extensively query `ConversationTurn` data to understand user behavior, VA performance, and conversation patterns.
* **Debugging Tools:** Crucial for replaying and inspecting conversation flows.

---

**8. Assumptions / Constraints:**

* Each `ConversationTurn` has a unique `turn_id` and a stable `conversation_id`.
* `turn_number` accurately reflects the chronological order within a `Conversation`.
* The data stored in `nlu_results`, `action_taken`, and `va_state_snapshot` (JSONB fields) is highly structured and parsable for programmatic access.
* This model is designed for auditing and analysis; it is not the primary mechanism for the VA's real-time state management (that's `brain:short_term_mem`).